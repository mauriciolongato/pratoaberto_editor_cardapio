<!DOCTYPE html>
<html lang="en">
<head   >
    <meta charset="UTF-8">
    <title>Prato Aberto - Editor Cardapio</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <style>

        /* Objetos da tabela */
        .row {
		    margin-top:40px;
		    padding: 0 10px;
		}

        .container {
            width: 80%;
        }

		.clickable{
		    cursor: pointer;
		}

		.panel-heading div {
			margin-top: -18px;
			font-size: 15px;
		}

		.panel-body{
			display: none;
		}

        .table-responsive {
            height:500px;
            overflow-y:auto;
            overflow-x:auto;
        }

		.panel-heading div span{
			margin-left:5px;
		}

        .table > tbody > tr > th,
        .table > tfoot > tr > th {
            font-size: 10px;
        }

        .table > tbody > tr > td,
        .table > tfoot > tr > td {
            vertical-align: inherit;
        }

        .navbar-nav {
            margin-top: 8px;
            padding-left:10px;
            padding-right: 15px;
        }

    </style>
</head>
<body>
    <div class="container">
        <!-- NAVBAR -->
        <div class="row">
            <nav class="navbar navbar-default">
                <div class="container-fluid">
                    <!-- Brand and toggle get grouped for better mobile display -->
                    <div class="navbar-header">
                        <a class="navbar-brand" href="#">Prato Aberto - Lista Escolas</a>
                    </div>
                    <ul class="nav navbar-nav navbar-right">
                        <a type="button" class="btn btn-default " href="/">
                            <span class="glyphicon glyphicon-chevron-left"></span> VOLTAR PARA CARDÁPIOS PENDENTES
                        </a>
                    </ul>
                </div>
            </nav>
        </div>

        <!-- Edição da escola -->
        <div class="modal fade" tabindex="-1" role="dialog" id="xml_form">
            <div class="modal-dialog" role="document" style="width: 70%">
                <form method="post" action="/atualiza_historico_escolas" enctype="multipart/form-data">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title">Edição da Escola</h4>
                        </div>

                        <div class="modal-body">
                            <div class="row" style="padding-right: 30px; padding-bottom: 15px;">
                                <a onclick="addRowModal()" class="btn btn-primary" style="float: right"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span></a>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover" id="edicao-escola">
                                    <thead>
                                        <tr>
                                            <th style="word-wrap: break-word;"></th>
                                            <th style="word-wrap: break-word;">COD_EOL</th>
                                            <th style="word-wrap: break-word;">GESTÃO</th>
                                            <th style="word-wrap: break-word;min-width: 90px;max-width: 150px;">ESCOLA</th>
                                            <th style="word-wrap: break-word;">AGRUPAMENTO</th>
                                            <th style="word-wrap: break-word;min-width: 150px;max-width: 150px;">EDITAL</th>
                                            <th style="word-wrap: break-word;">DATA</th>
                                            <th style="word-wrap: break-word;min-width: 400px;max-width: 400px;">NOME</th>
                                            <th style="word-wrap: break-word;min-width: 400px;max-width: 400px;">ENDEREÇO</th>
                                            <th style="word-wrap: break-word;min-width: 150px;max-width: 150px;">BAIRRO</th>
                                            <th style="word-wrap: break-word;">LAT</th>
                                            <th style="word-wrap: break-word;">LON</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">FECHAR</button>
                            <button type="submit" onclick="geraTabela()" class="btn btn-success">SALVAR</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>


        <div class="row">
            <button onclick="addRow()" class="btn btn-primary" style="float: right"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span></button>
        </div>

       	<div class="row">
            <div class="panel panel-success">
                <div class="panel-heading">
                    <h2 class="panel-title">Escolas</h2>
                    <div class="pull-right">
                        <span class="clickable filter" data-toggle="tooltip" title="Toggle table filter" data-container="body">
                            <i class="glyphicon glyphicon-filter"></i>
                        </span>
                    </div>
                </div>
                <div class="panel-body">
                    <input type="text" class="form-control" id="task-table-filter" data-action="filter" data-filters="#task-table" placeholder="Filter Tasks" />
                </div>
                <div class="table-responsive">
                    <div>
                        <table class="table table-hover table-striped" id="task-table">
                            <thead>
                                <tr>
                                    <th style="word-wrap: break-word;"></th>
                                    <th style="word-wrap: break-word;">COD_EOL</th>
                                    <th style="word-wrap: break-word;">GESTÃO</th>
                                    <th style="word-wrap: break-word;min-width: 150px;max-width: 150px;">ESCOLA</th>
                                    <th style="word-wrap: break-word;">AGRUPAMENTO</th>
                                    <th style="word-wrap: break-word;min-width: 150px;max-width: 150px;">EDITAL</th>
                                    <th style="word-wrap: break-word;">DATA</th>
                                    <th style="word-wrap: break-word;min-width: 400px;max-width: 400px;">NOME</th>
                                    <th style="word-wrap: break-word;min-width: 400px;max-width: 400px;">ENDEREÇO</th>
                                    <th style="word-wrap: break-word;min-width: 150px;max-width: 150px;">BAIRRO</th>
                                    <th style="word-wrap: break-word;">LAT</th>
                                    <th style="word-wrap: break-word;">LON</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for linha in escolas: %}
                                <tr class="item" id="{{ linha['_id'] }}">
                                    <td><a class="btn btn-info" onclick='editRow(this)' href="#" data-toggle="modal" data-target="#xml_form">EDITAR</a></td>
                                    <td class="cod_eol">{{ linha['_id'] }}</td>
                                    <td class="tipo_atendimento">{{ linha['tipo_atendimento'] }}</td>
                                    <td class="tipo_unidade">{{ linha['tipo_unidade'] }}</td>
                                    <td class="agrupamento">{{ linha['agrupamento'] }}</td>
                                    <td class="edital">{{ linha['edital'] }}</td>
                                    <td class="data">{{ linha['data_inicio_vigencia'] }}</td>
                                    <td class="nome">{{ linha['nome'] }}</td>
                                    <td class="endereco">{{ linha['endereco'] }}</td>
                                    <td class="bairro">{{ linha['bairro'] }}</td>
                                    <td class="lat">{{ linha['lat'] }}</td>
                                    <td class="lon">{{ linha['lon'] }}</td>
                                </tr>
                                    {% for linha_historico in linha['historico']: %}
                                        <tr class="item" style="background-color: #FFEEAD;display: none;" id="{{ linha['_id'] }}">
                                            <td><a value='Delete' onclick='deleteRowModal(this)'><i style='color:#D9534F;font-size:30px;text-align: center' class='fa'></i></a></td>
                                            <td class="cod_eol" contenteditable='true'>{{ linha['_id'] }}</td>
                                            <td class="tipo_atendimento" contenteditable='true'>{{ linha_historico['tipo_atendimento'] }}</td>
                                            <td class="tipo_unidade" contenteditable='true'>{{ linha_historico['tipo_unidade'] }}</td>
                                            <td class="agrupamento" contenteditable='true'>{{ linha_historico['agrupamento'] }}</td>
                                            <td class="edital" contenteditable='true'>{{ linha_historico['edital'] }}</td>
                                            <td class="data" contenteditable='true'>{{ linha_historico['data_inicio_vigencia'] }}</td>
                                            <td class="nome" contenteditable='true'>{{ linha['nome'] }}</td>
                                            <td class="endereco" contenteditable='true'>{{ linha['endereco'] }}</td>
                                            <td class="bairro" contenteditable='true'>{{ linha['bairro'] }}</td>
                                            <td class="lat" contenteditable='true'>{{ linha['lat'] }}</td>
                                            <td class="lon" contenteditable='true'>{{ linha['lon'] }}</td>
                                        </tr>
                                    {% endfor %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <footer class="container-fluid text-center">
            <br>
            <p><a href="http://pratoaberto.sme.prefeitura.sp.gov.br/" title="Projeto Prato Aberto">http://pratoaberto.sme.prefeitura.sp.gov.br/</a></p>
            <table id="lista-modificacoes">
                <tbody style="display:none">
            </table>
        </footer>
    </div>

    <!-- Script com a funcionalidade do filtro da tabela -->
    <script>
        /**
        *   I don't recommend using this plugin on large tables, I just wrote it to make the demo useable. It will work fine for smaller tables
        *   but will likely encounter performance issues on larger tables.
        *
        *		<input type="text" class="form-control" id="dev-table-filter" data-action="filter" data-filters="#dev-table" placeholder="Filter Developers" />
        *		$(input-element).filterTable()
        *
        *	The important attributes are 'data-action="filter"' and 'data-filters="#table-selector"'
        */
        (function(){
            'use strict';
            var $ = jQuery;
            $.fn.extend({
                filterTable: function(){
                    return this.each(function(){
                        $(this).on('keyup', function(e){
                            $('.filterTable_no_results').remove();
                            var $this = $(this),
                                search = $this.val().toLowerCase(),
                                target = $this.attr('data-filters'),
                                $target = $(target),
                                $rows = $target.find('tbody tr');

                            if(search == '') {
                                $rows.show();
                            } else {
                                $rows.each(function(){
                                    var $this = $(this);
                                    $this.text().toLowerCase().indexOf(search) === -1 ? $this.hide() : $this.show();
                                })
                                if($target.find('tbody tr:visible').size() === 0) {
                                    var col_count = $target.find('tr').first().find('td').size();
                                    var no_results = $('<tr class="filterTable_no_results"><td colspan="'+col_count+'">No results found</td></tr>')
                                    $target.find('tbody').append(no_results);
                                }
                            }
                        });
                    });
                }
            });
            $('[data-action="filter"]').filterTable();
        })(jQuery);

        $(function(){
            // attach table filter plugin to inputs
            $('[data-action="filter"]').filterTable();

            $('.container').on('click', '.panel-heading span.filter', function(e){
                var $this = $(this),
                    $panel = $this.parents('.panel');

                $panel.find('.panel-body').slideToggle();
                if($this.css('display') != 'none') {
                    $panel.find('.panel-body input').focus();
                }
            });
            $('[data-toggle="tooltip"]').tooltip();
        })
    </script>

    <!-- Deleta linha da tabela -->
    <script>
        function deleteRow(r) {
            var i = r.parentNode.parentNode.rowIndex;
            document.getElementById("task-table").deleteRow(i);
        }
    </script>

    <!-- Adiciona linhas na tabela -->
    <script>
        function addRow() {
            $('#task-table').append(
                "<tr class='item' id=''>" +
                "<td><a class='btn btn-info' onclick='editRow(this)' href='#' data-toggle='modal' data-target='#xml_form'>EDITAR</a></td>" +
                "<td class='cod_eol' contenteditable='true'>COD EOL</td>" +
                "<td class='tipo_atendimento' contenteditable='true'>NOVO</td>" +
                "<td class='tipo_unidade' contenteditable='true'>TERCEIRIZADA</td>" +
                "<td class='agrupamento' contenteditable='true'>A DEFINIR</td>" +
                "<td class='edital' contenteditable='true'>EDITAL1</td>" +
                "<td class='nome' contenteditable='true'></td>" +
                "<td class='endereco' contenteditable='true'></td>" +
                "<td class='bairro' contenteditable='true'></td>" +
                "<td class='lat' contenteditable='true'></td>" +
                "<td class='lon' contenteditable='true'></td>" +
                "</tr>"
            );
        };

    </script>

    <!-- Monta tabela -->
    <script>
        function geraTabela() {
            json_dump = [];
            $('#task-table tr.item').each(function () {
                var tipo_gestao = $(this).find(".tipo_gestao").html();
                var tipo_escola = $(this).find(".tipo_escola").html();
                var edital = $(this).find(".edital").html();
                var dia_semana = $(this).find(".dia_semana").html();
                var idade = $(this).find(".idade").html();
                var refeicao = $(this).find(".refeicao").html();
                var cardapio = $(this).find(".cardapio").html();
                var Tabela = [tipo_gestao, tipo_escola, edital, dia_semana, idade, refeicao, cardapio]
                json_dump.push(Tabela);
            });
            $('#json_dump').attr('value', JSON.stringify(json_dump))

        }
    </script>

    <!-- Cria json da tabela -->
    <script>
        $('#post_json').submit(function() {
            json_dump = [];
            lista_codigo_eol_modificacoes = {}
            $('#lista-modificacoes tr.item').each(function () {
                var cod_eol_modificacao = $($(this).children('td')[0]).text();
                lista_codigo_eol_modificacoes[cod_eol_modificacao] = 1
            });

            $('#task-table tr.item').each(function () {
                for (var key in lista_codigo_eol_modificacoes) {
                    if (key == $($(this).children('td')[2]).text()) {
                        var cod_eol = $($(this).children('td')[2]).text();
                        var tipo_atendimento = $($(this).children('td')[3]).text();
                        var tipo_unidade = $($(this).children('td')[4]).text();
                        var agrupamento = $($(this).children('td')[5]).text();
                        var edital = $($(this).children('td')[6]).text();
                        var data = $($(this).children('td')[7]).text();
                        var nome = $($(this).children('td')[8]).text();
                        var endereco = $($(this).children('td')[9]).text();
                        var bairro = $($(this).children('td')[10]).text();
                        var lat = $($(this).children('td')[11]).text();
                        var lon = $($(this).children('td')[12]).text();
                        modificacao = {
                            '_id' : cod_eol,
                            'nome': nome,
                            'tipo_unidade' : tipo_unidade,
                            'tipo_atendimento': tipo_atendimento,
                            'agrupamento': agrupamento,
                            'edital': edital,
                            'endereco': endereco,
                            'bairro': bairro,
                            'lat': lat,
                            'lon': lon,
                            'data_inicio_vigencia': data}

                        json_dump.push(modificacao)

                    }
                }
            });
            $('#json_dump').attr('value', JSON.stringify(json_dump))
            return true; // return false to cancel form action
        });


    </script>

    <!-- Edita escola -->
    <script>
        function editRow(r) {
            $('#edicao-escola tr').not(':first').empty();
            $('#task-table tr').not(':first').each(function() {
                var semana_linha = $($(this).children('td')[1]).text()
                if (semana_linha == $($($(r).closest('tr')).children('td')[1]).text()) {
                    var cod_eol = $($(this).children('td')[1]).text();
                    var tipo_atendimento = $($(this).children('td')[2]).text();
                    var tipo_unidade = $($(this).children('td')[3]).text();
                    var agrupamento = $($(this).children('td')[4]).text();
                    var edital = $($(this).children('td')[5]).text();
                    var data = $($(this).children('td')[6]).text();
                    var nome = $($(this).children('td')[7]).text();
                    var endereco = $($(this).children('td')[8]).text();
                    var bairro = $($(this).children('td')[9]).text();
                    var lat = $($(this).children('td')[10]).text();
                    var lon = $($(this).children('td')[11]).text();

                    $('#edicao-escola').append(
                        "<tr class='item'>" +
                        "<td><a value='Delete' onclick='deleteRowModal(this)'><i style='color:#D9534F;font-size:30px;text-align: center' class='fa'></i></a></td>" +
                        "<td class='cod_eol'>"+cod_eol+"</td>" +
                        "<td class='tipo_atendimento' contenteditable='true'>"+tipo_atendimento+"</td>" +
                        "<td class='tipo_unidade' contenteditable='true'>"+tipo_unidade+"</td>" +
                        "<td class='agrupamento' contenteditable='true'>"+agrupamento+"</td>" +
                        "<td class='edital' contenteditable='true'>"+edital+"</td>" +
                        "<td class='data' contenteditable='true'>"+data+"</td>" +
                        "<td class='nome' contenteditable='true'>"+nome+"</td>" +
                        "<td class='endereco' contenteditable='true'>"+endereco+"</td>" +
                        "<td class='bairro' contenteditable='true'>"+bairro+"</td>" +
                        "<td class='lat' contenteditable='true'>"+lat+"</td>" +
                        "<td class='lon' contenteditable='true'>"+lon+"</td>" +
                        "</tr>"
                    );
                }
            });
        }

    </script>

    <!-- Deleta linha da tabela Modal -->
    <script>
        function deleteRowModal(r) {
            var i = r.parentNode.parentNode.rowIndex;
            document.getElementById("edicao-escola").deleteRow(i);
        }
    </script>

    <!-- Adiciona linhas na tabela Modal -->
    <script>
        function addRowModal() {
            $('#edicao-escola').append(
                "<tr class='item' id=''>" +
                "<td><a value='Delete' onclick='deleteRowModal(this)'><i style='color:#D9534F;font-size:30px;text-align: center' class='fa'></i></a></td>" +
                "<td class='cod_eol' contenteditable='true'>Código EOL</td>" +
                "<td class='tipo_atendimento' contenteditable='true'>Tipo Atendimento</td>" +
                "<td class='tipo_unidade' contenteditable='true'>Tipo Unidade</td>" +
                "<td class='agrupamento' contenteditable='true'>Agrupamento</td>" +
                "<td class='edital' contenteditable='true'>EDITAL1</td>" +
                "<td class='data' contenteditable='true'>Data</td>" +
                "<td class='nome' contenteditable='true'>Nome Escola</td>" +
                "<td class='endereco' contenteditable='true'>Endereço</td>" +
                "<td class='bairro' contenteditable='true'>Bairro</td>" +
                "<td class='lat' contenteditable='true'></td>" +
                "<td class='lon' contenteditable='true'></td>" +
                "</tr>"
            );
        };

    </script>


</body>
</html>